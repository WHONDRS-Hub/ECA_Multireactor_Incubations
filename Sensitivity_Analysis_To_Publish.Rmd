---
title: "ECA_Optode_Respiration_Sensitivity_Analysis"
author: "MML"
date: "2023-10-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


```

```{r libraries, include = FALSE}

library(dplyr); library(ggplot2);library(ggsignif)
library(ggpubr);library(reshape2);library(ggpmisc)
library(segmented);library(broom);library(lmtest);library(car)
library(ggpmisc);library(lubridate); library(readxl);
library(tidyverse);library(patchwork)
library(readr)

```
## Read in and clean raw DO data.
* Remove all missing samples with missing values: 
    + EC_027_INC-D1, D2, W5 : Bad lighting,       overexposed samples
    + EC_013_INC-D4, W5 : Bad lighting, overexposed samples
   + EC_014_INC-W5 : Bad lighting, overexposed samples
   + EC_072_INC-D5, W5 : Not enough sample for five replicates
   + EC_091_INC-D5 : Sample fell off rollers at this time
   + EC_014_INC-W1 : Bad measurements for first 6 minutes
   + EC_011-W and EC_012-W : Too much water added at beginning of 21-day incubation
   

```{r Load and Clean Data, include = FALSE}

rm(list=ls());graphics.off()

# Set working directory to data file
#Example:
pnnl.user = 'laan208'

input.path = paste0("C:/Users/",pnnl.user,"/PNNL/Core Richland and Sequim Lab-Field Team - Documents/Data Generation and Files/ECA/Optode multi reactor/Optode_multi_reactor_incubation/rates/Raw_DO_by_Min/EC_INC_ReadyForBoye_10-03-2023.csv")

output.path = paste0("C:/Users/",pnnl.user,"/PNNL/Core Richland and Sequim Lab-Field Team - Documents/Data Generation and Files/ECA/Optode multi reactor/Optode_multi_reactor_incubation/rates/Plots/Sensitivity_Analysis/")

data = read.csv(input.path)

# Remove missing data points
samples = data %>% 
  filter(DO_mg_per_L != -9999) 

```
## Start testing rules:

* Minimum Number of Points (min.points) = 2
  + Keep at least 2 points to generate a slope
  
* Slope Threshold (slope.thresh) = -0.006
  + Don't remove points from slopes if the initial fit has a slope greater than this value. This value was chosen manually. 
  
* Low Dissolved Oxygen Threshold (do.thresh) = 2
  + Used in initial removal of data points below this value in conjunction with time threshold
  
* Time Threshold (time.thresh) = 4
  + Used in conjunction with Dissolved Oxygen Threshold to remove points below Dissolved Oxygen Threshold at a certain time
  
* High Dissolved Oxygen Threshold (high.do) = 14
  + Initial removal of data points above this value

* Fast Rate Threshold (fast) = 5.5 
  + Use theoretical saturated 0 minute value if 2 minute value is below this threshold
   + 5.5 has least number of differences between theoretical and real slopes between replicates
  + Tested range: 4.5, 5.0, 5.5, 6.0, 6.5, 7.0, 7.5, No removal
 
* Breusch-Pagan Heteroscedasticity Test (bp.fit) = 0.1
  + p-value used to determine normal distribution of residuals
  + 0.1 middle of selection, no large differences in histograms
  + Tested range: 0.025, 0.05, 0.075, 0.1, 0.125, 0.15, No removals

* High Slope Threshold (high.slope.thresh) = -0.04
  + Remove saturation point if slope is pretty flat     but starts low (might be able to remove)

* Time Same (time.same) = 7
  + Keep 2 minute DO value even if it was put on the rollers at the same time a photo was taken if it is lower than this value
  
* Break Point Toggle (break.toggle) = 1.4 
  + Ratio between slope before/after breaking data at predicted segmented regression point
  + 1.4 was best for breaking more non-linear slopes upon manual inspection, however changing the ratio doesn't change histograms
  + Tested range: 1.0, 1.2, 1.4, 1.6, 1.8, 2.0
 
* Concentration Toggle = 1.4
  + Range between first and last DO concentration in data frame, used to keep more linear slopes from breaking/having points removed in heteroscedasticity 
  + 1.4 was best for not removing data//using segmented regression for more linear samples
  + Tested range: 0, 0.5, 1.0, 1.4, 1.5, 2.0

```{r Set Parameters}

min.points = 2
slope.thresh = -0.006
do.thresh = 2
high.do = 14
time.thresh = 4
fast = 5.5 
bpfit = 0.1
high.slope.thresh = -0.04 
time.same = 7
break.toggle = 1.4
conc.range = 1.4
plot.toggle = FALSE

```
## Fit a linear model to data with chosen rules

```{r Start Loop for fitting Linear Models, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 8, fig.wight = 8}

# Make Data Frames
respiration <- as.data.frame(matrix(NA, ncol = 17, nrow =1))

colnames(respiration) = c("Sample_Name","slope_of_the_regression", "rate_mg_per_L_per_min", "rate_mg_per_L_per_h", "R_squared", "R_squared_adj",  "p_value", "total_incubation_time_min", "number_of_points", "no_points_rem",  "breusch_p_value","break_point", "slope_ratio",  "0_min_concentration", "2_min_concentration", "last_concentration", "theoretical")

location = c("-W1", "-W2", "-W3","-W4", "-W5","-D1", "-D2", "-D3", "-D4", "-D5")

rate = as.data.frame(matrix(NA, ncol = 14, nrow = length(unique(samples$Sample_Name))))

colnames(rate) = c("Sample_Name", "slope_of_the_regression", "rate_mg_per_L_per_min", "rate_mg_per_L_per_h", "R_squared", "R_squared_adj", "p_value", "total_incubation_time_min", "breusch_p_value", "slope_ratio", "0_min_concentration", "2_min_concentration", "last_concentration", "theoretical")

for (i in 1:length(location)){
  
  ## Subset by replicate
  
 data_location_subset = samples[grep(location[i],samples$Sample_Name),]
  
   unique.incubations = unique(data_location_subset$Sample_Name)
   
   rate = as.data.frame(matrix(NA, ncol = 14, nrow = length(unique(samples$Sample_Name))))

colnames(rate) = c("Sample_Name", "slope_of_the_regression", "rate_mg_per_L_per_min", "rate_mg_per_L_per_h", "R_squared", "R_squared_adj", "p_value", "total_incubation_time_min", "breusch_p_value", "slope_ratio", "0_min_concentration", "2_min_concentration", "last_concentration", "theoretical")
  
  for (j in 1:length(unique.incubations)){
    
    # Subset by individual sites
    
    data_site_subset = subset(data_location_subset, data_location_subset$Sample_Name == unique.incubations[j])
    
    # Put in ascending order for minutes
    data_site_subset = data_site_subset[order(data_site_subset$Elapsed_Minute, decreasing = FALSE),]
    data_site_subset$Elapsed_Minute = as.numeric(data_site_subset$Elapsed_Minute)
    
   # Fit linear model to all data
    
    fit_all = lm(DO_mg_per_L~Elapsed_Minute, data = data_site_subset)
   
    # Remove points greater than High Dissolved Oxygen Threshold
    
    data_site_subset_low = data_site_subset %>% 
      filter(DO_mg_per_L < high.do) 
    
  # Fit linear model to slopes with High Dissolved Oxygen Points Removed
    
    fit_low = lm(DO_mg_per_L~Elapsed_Minute, data = data_site_subset_low)
    
    low.slope = fit_low$coefficients[[2]]
    
    # Remove samples if at >6 minutes, they are below the DO threshold. This is removing low values from the back end of curves
    
    data_site_subset_thresh = data_site_subset_low %>% 
      filter(!(Elapsed_Minute > 4 & DO_mg_per_L < do.thresh)) 
    
    data_site_subset_rem = data_site_subset_thresh
    
    # If the 2 minute concentration is less than the Dissolved Oxygen Threshold set to remove low values from the back end of the curve, remove anything greater than 2 minutes
    
    for(n in 1:2){
      if(data_site_subset_rem$Elapsed_Minute[2] == 2 & data_site_subset_rem$DO_mg_per_L[2] <= do.thresh){
        
        data_site_subset_rem = data_site_subset_rem %>% 
          filter(!Elapsed_Minute > 2 )
        
      }
    }
    
    # Keep saturation point from samples with 2 minute point that starts below set threshold. 
    
    data_site_subset_fast = data_site_subset_rem
    

      if (data_site_subset_fast$DO_mg_per_L[2] <= fast & data_site_subset_fast$Elapsed_Minute[2] <= time.thresh ){
        
        data_site_subset_fast = data_site_subset_fast
        
      } else if (data_site_subset_fast$DO_mg_per_L[2] >= fast){
      
         data_site_subset_fast = data_site_subset_fast[-1,]
        
      }

    # Remove 2 minute point if put on at same time as picture is taken
    
    data_site_subset_beg = data_site_subset_fast
    
    for (k in 1:2) {

      if (nrow(data_site_subset_beg) <= 2) {
  
        # If dataset only consists of 0 minute and 2 minute point, don't remove data
        
        data_site_subset_beg = data_site_subset_beg
        
      }

      else if (grepl("RATE_006", data_site_subset_beg$Methods_Deviation[k]) & ((data_site_subset_beg$DO_mg_per_L[k] > time.same & data_site_subset_beg$Elapsed_Minute[k] == 2))) {

        ## If samples were put on roller the same time as a picture was taken (indicated by RATE_006 Method Deviation) and the dissolved oxygen concentration is greater than the set threshold at the 2 minute measurement, remove the 2 minute point 
        
        data_site_subset_beg = data_site_subset_beg[-k,]

      }

    }
    
    # If the first point is 0, only keep 2 points 
    
      if (data_site_subset_beg$Elapsed_Minute[1] == 0) {
        
        data_site_subset_beg = head(data_site_subset_beg, 2)
      
        }
      
    # Fit linear model to cleaned data (low points removed, high points removed, first point removed if put on rollers at same time as picture) 
    
    fitog = lm(DO_mg_per_L~Elapsed_Minute, data = data_site_subset_beg)
   slope_original = fitog$coefficients[[2]] #slope of original cleaned data
   
  # Calculate segmented regression slopes:
    
    if (nrow(data_site_subset_beg) > 3) {
    
      ## Only works if more than 3 rows of data, fits segmented regession and gets best estimate of where to break the data
      
      # psi gives estimated start point for the analysis
      
      segmentog = segmented(fitog, seg.Z = ~Elapsed_Minute, psi = (((max(data_site_subset_beg$Elapsed_Minute)-min(data_site_subset_beg$Elapsed_Minute))/2)+min(data_site_subset_beg$Elapsed_Minute)))
    
    fit_seg = numeric(length(data_site_subset_beg$Elapsed_Minute)) * NA

    # gives DO estimates for segmented regression lm
    fit_seg[complete.cases(rowSums(cbind(data_site_subset_beg$DO_mg_per_L, data_site_subset_beg$Elapsed_Minute)))] <- broken.line(segmentog)$fit

    data_seg = data.frame(DO_mg_per_L = data_site_subset_beg$DO_mg_per_L, Elapsed_Minute = data_site_subset_beg$Elapsed_Minute, fit = fit_seg)
    
    # 1: Initial Break Point, 2: Chosen Break Point, 3: Approx. Standard Error
    seg = segmentog$psi
    #Chosen Break Point
    est = seg[[2]]
    #Standard Error
    bp_se = seg[[3]]
    #Rounded Break Point
    data_site_subset_beg$break_point = 2*round(seg[[2]]/2)
    
    #Break Data at rounded value
    data_site_subset_break = subset(data_site_subset_beg, Elapsed_Minute <= data_site_subset_beg$break_point[1])
     
  } else {
      
    # If number of rows < 3, don't fit segmented regression
    
      data_site_subset_beg = data_site_subset_beg
      
      est = "NA"
      
      data_site_subset_break = data_site_subset_beg
      
     }

    # Fit linear model to segmented data
    fit_break = lm(DO_mg_per_L~Elapsed_Minute, data = data_site_subset_break)
    u = fit_break$coefficients
    b = u[[1]] #intercept
    c = u[[2]] #slope
    slope_beginning = c
    r = summary(fit_break)$r.squared #r squared of segmented data
    residuals = deviance(fit_break)
    r.adj = summary(fit_break)$adj.r.squared
    p = summary(fit_break)$coefficients[4]
    pog = p
    rog = r
    resog = residuals
    bp = bptest(fit_break)[[4]]
    bpog = bptest(fit_break)[[4]]

    #Calculate ratio of slopes before and after segmented regression
    
     slope.ratio = fit_break$coefficients[[2]]/fitog$coefficients[[2]]
    
     #If ratio of slopes before/after segmented regression, the original slope is not flat, and the range of the concentrations from the unbroken data is > 1.4, then use the segmented regression
     
    if(slope.ratio > break.toggle & slope_original < slope.thresh & (first(data_site_subset_beg$DO_mg_per_L) - last(data_site_subset_beg$DO_mg_per_L)) > conc.range) {
    
    data_site_subset_fin = data_site_subset_break
    
    } else {
      
      data_site_subset_break = data_site_subset_beg
      
      data_site_subset_fin = data_site_subset_break
      
    }
    
     # Fit final lm to data after deciding to use segmented regression or not
     fit_break = lm(DO_mg_per_L~Elapsed_Minute, data = data_site_subset_fin)
    u = fit_break$coefficients
    b = u[[1]] #intercept
    c = u[[2]] #slope
    slope_beginning = c
    r = summary(fit_break)$r.squared
    residuals = deviance(fit_break)
    r.adj = summary(fit_break)$adj.r.squared
    p = summary(fit_break)$coefficients[4]
    pog = p
    rog = r
    resog = residuals
    bp = bptest(fit_break)[[4]]
    bpog = bptest(fit_break)[[4]]

    # Fit lm to data, this will change with loop
    fit = lm(data_site_subset_fin$DO_mg_per_L~data_site_subset_fin$Elapsed_Minute)
    u = fit$coefficients
    b = u[[1]] #Intercept
    c = u[[2]] #rate mg/L min
    r = summary(fit)$r.squared
    r.adj = summary(fit)$adj.r.squared
    residuals = deviance(fit)
    p = summary(fit)$coefficients[4]
    r2 = r
    res2 = residuals
    bp = bptest(fit)[[4]]
    
  
    
    if (slope_beginning >= slope.thresh | ((first(data_site_subset_beg$DO_mg_per_L) - last(data_site_subset_beg$DO_mg_per_L)) < conc.range)) 
   
    {
      
        #if it has a flat slope, or original data has low concentration range in cleaned data, don't do anything else
      
      data_site_subset_fin = data_site_subset_fin
      
      fit = lm(data_site_subset_fin$DO_mg_per_L~data_site_subset_fin$Elapsed_Minute)
      u = fit$coefficients
      b = u[[1]] #Intercept
      c = u[[2]] #rate mg/L min
      r = summary(fit)$r.squared
      r.adj = summary(fit)$adj.r.squared
      residuals = deviance(fit)
      p = summary(fit)$coefficients[4]
      r2 = r
      res2 = residuals
      bp = bptest(fit)[[4]]
      
    }
    
    else {
    
      #else start looping to remove data
      
      for (l in 1:60) {
        
        if (nrow(data_site_subset_fin)<= min.points){
          
          #if there are more 2 or less points fit final lm to final data:
          
          data_site_subset_fin = data_site_subset_fin
          
          fit = lm(data_site_subset_fin$DO_mg_per_L~data_site_subset_fin$Elapsed_Minute)
          u = fit$coefficients
          b = u[[1]] #Intercept
          c = u[[2]] #rate mg/L min
          r = summary(fit)$r.squared
          r.adj = summary(fit)$adj.r.squared
          residuals = deviance(fit)
          p = summary(fit)$coefficients[4]
          r2 = r
          res2 = residuals
          bp = bptest(fit)[[4]]
          
        }
        
        else if (bp < bpfit & nrow(data_site_subset_fin) >= min.points){
        
          #Else if the p-value of the Breusch-Pagan Heteroscedasticity test is less than the threshold, start removing data from the back end until it is greater than threshold or there are only 2 points
          
          data_site_subset_fin = data_site_subset_fin[-nrow(data_site_subset_fin),]
        
        fit = lm(data_site_subset_fin$DO_mg_per_L~data_site_subset_fin$Elapsed_Minute)
        u = fit$coefficients
        b = u[[1]] #Intercept
        c = u[[2]] #rate mg/L min
        r = summary(fit)$r.squared
        r.adj = summary(fit)$adj.r.squared
        residuals = deviance(fit)
        p = summary(fit)$coefficients[4]
        r2 = r
        res2 = residuals
        bp = bptest(fit)[[4]]
        
          }

      }
      
      if (slope_beginning < 0 & c > 0){
        
        # If the slope of the final is positive, use the slope of the cleaned data
        
        data_site_subset_fin = data_site_subset_beg
        
        fit = lm(data_site_subset_fin$DO_mg_per_L~data_site_subset_fin$Elapsed_Minute)
        u = fit$coefficients
        b = u[[1]] #Intercept
        c = u[[2]] #rate mg/L min
        r = summary(fit)$r.squared
        r.adj = summary(fit)$adj.r.squared
        residuals = deviance(fit)
        p = summary(fit)$coefficients[4]
        r2 = r
        res2 = residuals
        bp = bptest(fit)[[4]]
        
        }
      
    }
        
  my.format <- "Slope: %s\nR2: %s\np: %s"  
  my.formula <- y ~ x
  
  #Make Plots for the following fits: Final Data, Break Point Data, Cleaned Data, Original Data
  
  if (plot.toggle == TRUE) {
     final <- ggplot(data_site_subset_fin, aes(x = Elapsed_Minute, y = DO_mg_per_L)) + coord_cartesian(ylim = c(0,15))+ geom_point(size = 2) + expand_limits(x = 0, y = 0) +
      geom_smooth(method = "lm", se=F, formula = my.formula) +
      geom_label(aes(x = 0, y = 13), size = 2.5, hjust = 0,
      label = paste("R2 = ", signif(summary(fit)$r.squared, 3),
                 "\nP = ", signif(summary(fit)$coefficients[[4]], 3),
                 "\nSlope = ", signif(fit$coefficients[[2]], 3)))+      theme_bw()+theme(legend.title = element_blank(),legend.background = element_rect(fill = 'NA'), legend.text = element_text(size = 12,face="bold"))+
      labs(y = expression(Dissolved_Oxygen_mg_per_L), x = expression(Time_Elapsed_min))+ theme(axis.text.x=element_text(size = 12,face="bold"))+
      ggtitle("Final " ,data_site_subset_fin$Sample_Name[1]) +
      theme(plot.title = element_text(lineheight=.8, face="bold"))+
      theme(axis.text.x=element_text(colour = c("black","black")))+
      theme(aspect.ratio=1)+
      theme(axis.text.y=element_text(size = 12,face="bold"))+
      theme(axis.title.x =element_text(size = 12,face="bold"))+
      theme(axis.title =element_text(size = 12,face="bold"))+
      theme(axis.title.y =element_text(size = 12,face="bold"))

    clean <- ggplot(data_site_subset_beg, aes(x = Elapsed_Minute, y = DO_mg_per_L)) + coord_cartesian(ylim = c(0,15))+ geom_point(size = 2) + expand_limits(x = 0, y = 0) +
      geom_smooth(method = "lm", se=F, formula = my.formula) +
      geom_label(aes(x = 0, y = 13), size = 2.5, hjust = 0,
                 label = paste("R2 = ", signif(summary(fitog)$r.squared, 3),
                               "\nP = ", signif(summary(fitog)$coefficients[[4]], 3),
                               "\nSlope = ", signif(fitog$coefficients[[2]], 3)))+
    theme_bw()+theme(legend.title = element_blank(),legend.background = element_rect(fill = 'NA'), legend.text = element_text(size = 12,face="bold"))+
      labs(y = expression(Dissolved_Oxygen_mg_per_L), x = expression(Time_Elapsed_min))+ theme(axis.text.x=element_text(size = 12,face="bold"))+
      ggtitle("Cleaned" ,data_site_subset_fast$Sample_Name[1]) +
      theme(plot.title = element_text(lineheight=.8, face="bold"))+
      theme(axis.text.x=element_text(colour = c("black","black")))+
      theme(aspect.ratio=1)+
      theme(axis.text.y=element_text(size = 12,face="bold"))+
      theme(axis.title.x =element_text(size = 12,face="bold"))+
      theme(axis.title =element_text(size = 12,face="bold"))+
      theme(axis.title.y =element_text(size = 12,face="bold"))

    break_rem <- ggplot(data_site_subset_break, aes(x = Elapsed_Minute, y = DO_mg_per_L)) + coord_cartesian(ylim = c(0,15))+ geom_point(size = 2) + expand_limits(x = 0, y = 0) +
      geom_smooth(method = "lm", se=F, formula = my.formula) +
      geom_label(aes(x = 0, y = 13), size = 2.5, hjust = 0,
                 label = paste("R2 = ", signif(summary(fit_break)$r.squared, 3),
                               "\nP = ", signif(summary(fit_break)$coefficients[[4]], 3),
                               "\nSlope = ", signif(fit_break$coefficients[[2]], 3)))+
    theme_bw()+theme(legend.title = element_blank(),legend.background = element_rect(fill = 'NA'), legend.text = element_text(size = 12,face="bold"))+
      labs(y = expression(Dissolved_Oxygen_mg_per_L), x = expression(Time_Elapsed_min))+ theme(axis.text.x=element_text(size = 12,face="bold"))+
      ggtitle("Break Point Removed ", data_site_subset_break$Sample_Name[1]) +
      theme(plot.title = element_text(lineheight=.8, face="bold"))+
      theme(axis.text.x=element_text(colour = c("black","black")))+
      theme(aspect.ratio=1)+
      theme(axis.text.y=element_text(size = 12,face="bold"))+
      theme(axis.title.x =element_text(size = 12,face="bold"))+
      theme(axis.title =element_text(size = 12,face="bold"))+
      theme(axis.title.y =element_text(size = 12,face="bold"))

    all <- ggplot(data_site_subset, aes(x = Elapsed_Minute, y = DO_mg_per_L)) + coord_cartesian(ylim = c(0,15))+ geom_point(size = 2) + expand_limits(x = 0, y = 0) +
      geom_smooth(method = "lm", se=F, formula = my.formula) +
      geom_label(aes(x = 0, y = 13), size = 2.5, hjust = 0,
                 label = paste("R2 = ", signif(summary(fit_all)$r.squared, 3),
    "\nP = ", signif(summary(fit_all)$coefficients[[4]], 3),
    "\nSlope = ", signif(fit_all$coefficients[[2]], 3)))+
      theme_bw()+theme(legend.title = element_blank(),legend.background = element_rect(fill = 'NA'), legend.text = element_text(size = 12,face="bold"))+
      labs(y = expression(Dissolved_Oxygen_mg_per_L), x = expression(Time_Elapsed_min))+ theme(axis.text.x=element_text(size = 12,face="bold"))+
      ggtitle("No Points Removed " ,data_site_subset$Sample_Name[1]) +
      theme(plot.title = element_text(lineheight=.8, face="bold"))+
      theme(axis.text.x=element_text(colour = c("black","black")))+
      theme(aspect.ratio=1)+
      theme(axis.text.y=element_text(size = 12,face="bold"))+
      theme(axis.title.x =element_text(size = 12,face="bold"))+
      theme(axis.title =element_text(size = 12,face="bold"))+
      theme(axis.title.y =element_text(size = 12,face="bold"))

   multi <- (final + break_rem + clean + all) +
   plot_layout(widths = c(2,2))

     for(m in 1:1){
     
      print(multi)
   
    }
   
  }

    rate$Sample_Name[j] = as.character(data_site_subset_fin$Sample_Name[1])
    rate$slope_of_the_regression[j] = round(as.numeric((c)),3) #in mg O2/L min
    rate$rate_mg_per_L_per_min[j] = round(abs(as.numeric((c))),3) #in mg O2/L min
    rate$rate_mg_per_L_per_h[j] = round(abs(as.numeric((c))*60),3) #in mg O2/L h 
    rate$R_squared[j] = round(as.numeric(abs(r)),3)
    rate$R_squared_adj[j] = round(as.numeric(abs(r.adj)),3)
    rate$p_value[j] = p
    rate$total_incubation_time_min[j] = as.numeric(tail(data_site_subset_fin$Elapsed_Minute, n = 1) - head(data_site_subset_fin$Elapsed_Minute, n = 1)) 

    rate$number_of_points[j] = nrow(data_site_subset_fin)
    rate$no_points_rem[j] = (as.numeric(nrow(data_site_subset)) - as.numeric(nrow(data_site_subset_fin)))
    rate$breusch_p_value[j] = round(as.numeric(bp),3)
    rate$slope_ratio[j] = round(as.numeric(slope.ratio),3)
    rate$`0_min_concentration`[j] = ifelse(
      first(data_site_subset_fin$Elapsed_Minute == 0), 
        subset(data_site_subset_fin$DO_mg_per_L,                             data_site_subset_fin$Elapsed_Minute == 0),
      "NA"
      )

rate$`2_min_concentration`[j] = ifelse(
  first(data_site_subset_fin$Elapsed_Minute == 4), 
    subset(data_site_subset_fin$DO_mg_per_L, 
    data_site_subset_fin$Elapsed_Minute == 4),
  subset(data_site_subset_fin$DO_mg_per_L,
  data_site_subset_fin$Elapsed_Minute == 2)) 
    
    rate$last_concentration[j] = last(data_site_subset_break$DO_mg_per_L)
    
    rate$break_point[j] = est
    
    rate$theoretical[j] = case_when(data_site_subset_fin$Elapsed_Minute[1] == 0 ~ "yes")
    
    }
  
  rate = rate[!is.na(rate$Sample_Name),]   
  # Combining the regression metrics across locations and unique incubations
  respiration = rbind(respiration,rate)
}

respiration = respiration[-1,]


#write.csv(respiration,paste0(output.path,"ECA_Sediment_Incubations_Respiration_Rates_", conc.range,"_Range_",Sys.Date(),".csv"), row.names = F)

```

## Remove Outlier Samples 
* A distance matrix is used to remove the replicate most unlike the others if the coefficient of variation is greater than 10%
  

```{r Remove Outlier Samples}

slope.new <- respiration %>%
   separate(Sample_Name, c("ECA", "kit", "rep"), sep = "_", remove = FALSE) %>%
  mutate(Treat = case_when(grepl("W",rep)~"Wet",
                           grepl("D", rep) ~"Dry")) %>%
  unite(kit_treat, kit, Treat, remove = FALSE) %>%
  group_by(kit_treat) %>%
  mutate(Mean_Slope_All = mean(slope_of_the_regression)) %>%
   mutate(cv_before_removal = (abs(sd(slope_of_the_regression)/mean(slope_of_the_regression)))*100) %>%
ungroup() %>%
    dplyr::select(c(Sample_Name, kit_treat, kit,rep,slope_of_the_regression,rate_mg_per_L_per_min,rate_mg_per_L_per_h, Treat, Mean_Slope_All, cv_before_removal))

 slope.new$flag <- NA

 slope.final <- as.data.frame(matrix(NA, ncol = 13, nrow =1))

 colnames(slope.final) = c("slope.temp","Sample_Name", "kit_treat", "kit", "rep", "rate_mg_per_L_per_min","rate_mg_per_L_per_h", "Treat", "Mean_Slope_All","cv_before_removal", "cv_after_removal", "Mean_Slope_Removed","flag")

unique.samples = unique(slope.new$kit_treat)

for (i in 1:length(unique.samples)) {

  data_subset = subset(slope.new, slope.new$kit_treat == unique.samples[i])

  slope.temp = as.numeric(data_subset$slope_of_the_regression)

  slope.temp.sd <- sd(slope.temp)
  slope.temp.mean <- mean(slope.temp)
  CV = abs((slope.temp.sd/slope.temp.mean)*100)

  #looping to get 4 out of 5 best samples
  for (sample.reduction in 1:5)  {

    if (slope.temp.mean == 0) {

      CV = 0

    }

    else if (length(slope.temp) > 4 & CV >= 10) {

      dist.temp = as.matrix(abs(dist(slope.temp)))
      dist.comp = numeric()

      for(slope.now in 1:ncol(dist.temp)) {

        dist.comp = rbind(dist.comp,c(slope.now,sum(dist.temp[,slope.now])))

      }

      dist.comp[,2] = as.numeric(dist.comp[,2])
      slope.temp = slope.temp[-which.max(dist.comp[,2])]

      slope.temp.sd <- sd(slope.temp)
      slope.temp.mean <- mean(slope.temp)
      slope.temp.cv <- abs((slope.temp.sd/slope.temp.mean)*100)
      CV = slope.temp.cv
      slope.temp.range <- max(slope.temp) - min(slope.temp)
      range = slope.temp.range

      }
  }

  if (length(slope.temp) >= 3) {

    slope.combined <- as.data.frame(slope.temp)

    slope.removed <- merge(slope.combined, data_subset, by.x = "slope.temp", by.y = "slope_of_the_regression", all.x = TRUE)

    slope.removed <- slope.removed[!duplicated(slope.removed$Sample_Name), ]

    slope.removed$cv_after_removal = as.numeric(abs((sd(slope.temp)/mean(slope.temp))*100))

    slope.removed$Mean_Slope_Removed = as.numeric(mean(slope.temp))

  }

  slope.final = rbind(slope.removed, slope.final)

  rm('slope.temp')
}

## This data frame has removed samples
slope.final$flag <- ifelse(slope.final$cv_before_removal < slope.final$cv_after_removal, "Issue in dropping sample", NA)

slope.final <- rename(slope.final, "slope_of_the_regression" = "slope.temp")

slope.final$rem <- abs(slope.final$slope_of_the_regression) - slope.final$rate_mg_per_L_per_min

slope.final <- slope.final[!is.na(slope.final$Sample_Name),]

```

## Calculate Effect Size/Make Histograms of data with no removals
```{r}

data_clean <- slope.new %>% 
  mutate(slope_of_the_regression = if_else(slope_of_the_regression>0,0,slope_of_the_regression)) %>%
  mutate(rate_mg = if_else(slope_of_the_regression>=0,0,rate_mg_per_L_per_min)) %>% 
  mutate(Mean_Slope_All = if_else(Mean_Slope_All >0,0,Mean_Slope_All)) %>% 
  mutate(Mean_Slope = abs(Mean_Slope_All))

wet_no <- ggplot(subset(data_clean, Treat %in% "Wet"), aes(x = rate_mg_per_L_per_min)) +
  geom_histogram()+
  ggtitle("Wet Rates, No Removals")+
  theme(strip.text = element_text(
    size = 4))

dry_no <- ggplot(subset(data_clean, Treat %in% "Dry"), aes(x = rate_mg_per_L_per_min)) +
  geom_histogram()+
  ggtitle("Dry Rates, No Removals")+
  theme(strip.text = element_text(
    size = 4))

data_clean_effect <- data_clean %>% 
  filter(!grepl(011, kit)) %>% 
  filter(!grepl(012, kit)) %>% 
  distinct(kit_treat, .keep_all = TRUE) %>% 
  group_by(kit) %>% 
  mutate(effect = (Mean_Slope[Treat == "Wet"] - Mean_Slope[Treat == "Dry"])) %>% 
  mutate(log_effect = log10(abs(effect+1))) %>% 
  distinct(kit, .keep_all = TRUE)
 
effect_no <- ggplot(data_clean_effect, aes(x = effect)) + 
  geom_histogram() +
  ggtitle("Effect Size, No Removals")+
  theme(strip.text = element_text(
    size = 4))


```


```{r Make histograms of all rates/Dataset with rates removed}

data_clean_removals = slope.final %>%
  mutate(slope_of_the_regression = if_else(slope_of_the_regression>0,0,slope_of_the_regression)) %>%
  mutate(rate_mg = if_else(slope_of_the_regression>=0,0,rate_mg_per_L_per_min)) %>%
  mutate(Mean_Slope_Removed = if_else(Mean_Slope_Removed>0,0,Mean_Slope_Removed)) %>%
  dplyr::select(c(Sample_Name,rate_mg, Mean_Slope_Removed)) %>%
  rename(rate_mg_per_L_per_min = rate_mg) %>%
  mutate(rate_mg_per_L_per_h = rate_mg_per_L_per_min*60) %>%
  separate(Sample_Name, into = c("EC", "kit", "INC"), remove = FALSE) %>%
  separate(Sample_Name, into = c("ID", "rep"), sep = "-", remove = FALSE) %>%
  mutate(Treat = case_when(grepl("W",rep)~"Wet",
                           grepl("D", rep) ~"Dry")) %>%
  unite(kit_treat, c("kit", "Treat"),  sep = "_", remove = FALSE)


wet_rem <- ggplot(subset(data_clean_removals, Treat %in% "Wet"), aes(x = rate_mg_per_L_per_min)) +
  geom_histogram()+
  ggtitle("Wet Rates, Removals")+
  theme(strip.text = element_text(
    size = 4))

dry_rem <- ggplot(subset(data_clean_removals, Treat %in% "Dry"), aes(x = rate_mg_per_L_per_min)) +
  geom_histogram()+
  ggtitle("Dry Rates, Removals")+
  theme(strip.text = element_text(
    size = 4))

data_clean_rem_effect <- data_clean_removals %>% 
  filter(!grepl(011, kit)) %>% 
  filter(!grepl(012, kit)) %>% 
  mutate(Mean_Slope = abs(Mean_Slope_Removed)) %>% 
  distinct(kit_treat, .keep_all = TRUE) %>% 
  group_by(kit) %>% 
  mutate(effect = (Mean_Slope[Treat == "Wet"] - Mean_Slope[Treat == "Dry"])) %>% 
  mutate(log_effect = log10(abs(effect+1))) %>% 
  distinct(kit, .keep_all = TRUE)
 
effect_rem <- ggplot(data_clean_rem_effect, aes(x = effect)) + 
  geom_histogram() +
  ggtitle("Effect Size, No Removals")+
  theme(strip.text = element_text(
    size = 4))

all <- (wet_no + wet_rem + dry_no + dry_rem + effect_no + effect_rem) +
  plot_layout(widths = c(3,3))

print(all)

effect.path <- paste0("C:/Users/",pnnl.user,"/PNNL/Core Richland and Sequim Lab-Field Team - Documents/Data Generation and Files/ECA/Optode multi reactor/Optode_multi_reactor_incubation/effect size/Effect_Size_Data/")



#write.csv(data_clean_rem_effect, paste0(effect.path,"Effect_Size_merged_by_", pnnl.user,"_on_",Sys.Date(),".csv"), row.names = F)

respiration.removals.path <- paste0("C:/Users/",pnnl.user,"/PNNL/Core Richland and Sequim Lab-Field Team - Documents/Data Generation and Files/ECA/Optode multi reactor/Optode_multi_reactor_incubation/rates/Plots/All_Respiration_Rates/")

#write.csv(data_clean_removals, paste0(respiration.removals.path,"removed_respiration_merged_by_", pnnl.user,"_on_",Sys.Date(),".csv"), row.names = F)

```